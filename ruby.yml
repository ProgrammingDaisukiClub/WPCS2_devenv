- name: Get rbenv from GitHub
  git:
    repo: https://github.com/rbenv/rbenv.git
    dest: /opt/rbenv

- name: Configure rbenv
  shell: ./configure
  args:
    chdir: /opt/rbenv/src

- name: Make rbenv
  shell: make -C src
  args:
    chdir: /opt/rbenv

- name: Add RBENV_ROOT
  lineinfile:
    create: yes
    state: present
    dest: /etc/bash.bashrc
    line: 'export RBENV_ROOT="/opt/rbenv"'

- name: Update PATH for rbenv
  lineinfile:
    state: present
    dest: /etc/bash.bashrc
    line: 'export PATH="/opt/rbenv/bin:$PATH" && eval "$(rbenv init -)"'

- name: Get ruby-build from GitHub
  git:
    repo: https://github.com/rbenv/ruby-build.git
    dest: /opt/rbenv/plugins/ruby-build

- name: Install libreadline-dev
  apt:
    name: libreadline-dev

- name: Install ruby
  shell: export RBENV_ROOT="/opt/rbenv"; /opt/rbenv/bin/rbenv install -s 2.4.0
  become: yes
  become_user: root

- name: Set rbenv
  shell: export RBENV_ROOT="/opt/rbenv"; /opt/rbenv/bin/rbenv global 2.4.0
  become: yes
  become_user: root

- name: Update PATH for gem
  lineinfile:
    state: present
    dest: /etc/bash.bashrc
    line: 'PATH="`ruby -e "puts Gem.user_dir"`/bin:$PATH"'

- gem: Install rails
    name: rails
    state: present
    executable: /opt/rbenv/shims/gem


